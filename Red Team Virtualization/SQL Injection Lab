# This lab will detail creating and exploiting an environment with an intentionally vulnerable SQL database.
# Scope: Kali VM as attacking machine. Ubuntu Server hosting vulnerable webpage and SQL database.
# Network: Both machines on Internal LAN receiving internet from VyOS firewall. 
# Tools/dependencies needed; attacker - sqlmap, webserver - apache2 php mariadb-server php-mysql libapache2-mod-php
## Different pages with vulns:
    index.php – basic home page
    db_connect.php – insecure database connection file
    search.php – vulnerable search form
    login.php – login form with insecure SQL
    register.php – registration form with raw SQL
    admin.php – displays user data with injectable filtering

# To begin with we will install both Kali and Ubuntu Server in our proxmox environment
Install dependencies on ubuntu
  sudo apt install apache2 php mariadb-server php-mysql libapache2-mod-php
Create the followig php webpages (see folder PHP for SQL Lab)
  - index.php
  - db_connect.php
  - search.php
  - login.php
  - register.php
  - admin.php
For our purposes we went with simply putting these files (with the exception of admin.php) directly into the /var/www/html directory.
admin.php we will hide in a hidden directory, to do this simply use:
sudo mkdir /.admin/
Then move admin.php into this directory -> sudo mv admin.php /var/www/html/.admin/ 
I like to use full path here, sometimes directory syntax can get funny even if you think you're in the proper directory already

At this point our website should be all setup, we should be able to access it from our kali machine and see the various input forms.
If you can't access it or run into blank php pages (only html is loading) some common things to troubleshoot are:

    First and foremost:
    Ensure apache2 and needed services are running, use systemctl

    Firewall rules: 
    (Ubuntu server uses ufw by default)
    To check current rules: sudo ufw status
    To allow port/service: sudo ufw allow 80/tcp
    To reload and apply rules: sudo ufw reload (ufw is lenient with this, rules take effect upon change without reload but this is good practice as other firewalls i.e. firewall-cmd MUST be reloaded before rules take effect)
    
    Blank PHP pages:
    This can be caused by various things, ensure php is enabled on your apache2: apache2ctl -M | grep "php"
    Figure out whether the problem is on the php side or database side:
    In my PHP for SQL Lab folder there is the test_db.php file, run this:
    If it returns only starting test... --> your php is working but the database is not
        * If this is the case then I recommend looking at the user you're trying to authenticate with, can check /var/log/apache2/error.log to verify
    If you see connected successfully --> but query fails to return usernames, query is likely the problem

At this point assuming the website is now completely operational we can begin enumeration using sqlmap or manually if you'd like
The site has several different different vulnerabilities to exploit so for this writeup we'll focus on a goal:
Change the price on the laptop to one that is far cheaper enabling us to theoretically get an expensive item for way less.

First we can perform some basic enumeration on the search.php page using sqlmap using the command:
sqlmap -u "http://site_ip/search.php?search=test" --dbms=mysql --batch
Upon running this we get back four distinct vulns on this page:
    boolean-based blind
    error-based
    time-based bline
    UNION based
sqlmap also returns the webserver and backend info such as apache version which is extremely helpful if we pivot to other web app testing on the page

Lets exploit the UNION based query
There are a couple of ways we can do this either using the url bar or the input field:
1. We can simply input '1 OR '1'='1 into the product search field, alternatively we can enter ?search='1 OR '1'='1 into the url bar (this would look like: http://site_ip/search.php?search='1 OR '1'='1)
Either way we do this query the site will return each product in the database and its information
If we wished to continue with this attack path then this information could be used for various things

We can also try to get all of the data in the users table in the vuln_db database:
For this you can work your way through enumeration first finding the db, then tables, etc.
sqlmap -u "http://site_ip/search.php?search=test" --batch -D vuln_db -T users --columns
This command shows us the inner workings of the inputs accepted by the various fields within the users column, in a more complicated setting we may go deeper into this to try to exploit this
however for this lab we can simply add one more flag to our first command to get all of the table data.
sqlmap -u "http://site_ip/search.php?search=test" --batch -D vuln_db -T users --columns --dump
--dump will give us all of the table entries
From here we can now login as any of these users, including the admin

An additional thing that we can do is try to find the hidden admin.php page containing the list of users/passwords:
for this we can try directory fuzzing with tools like ffuf, we can automatically scan with something like zaproxy, or we can manually do this with burp suite
with ffuf it looks like this: ffuf -u "URL" -w "wordlist"

Note these are just a couple of the methods that can be used on this site
