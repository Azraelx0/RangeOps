<?php
# Database configuration
$db_host = 'localhost';
$db_user = 'root';
$db_pass = '';  # Add your MySQL root password if you set one
$db_name = 'vuln_db';

# Connect WITHOUT specifying database first
$conn = mysqli_connect($db_host, $db_user, $db_pass);

# Display errors
mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
error_reporting(E_ALL);
ini_set('display_errors', 1);

if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

function setup_database() {
    global $conn, $db_name;
    
    # Create database if it doesn't exist
    $create_db = "CREATE DATABASE IF NOT EXISTS vuln_db";
    mysqli_query($conn, $create_db);
    mysqli_select_db($conn, $db_name);
    
    # Create users table
    $create_users = "CREATE TABLE IF NOT EXISTS users (
        id INT AUTO_INCREMENT PRIMARY KEY,
        username VARCHAR(50) NOT NULL UNIQUE,
        password VARCHAR(255) NOT NULL,
        email VARCHAR(100),
        role VARCHAR(20) DEFAULT 'user',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )";
    mysqli_query($conn, $create_users);
    
    # Create products table
    $create_products = "CREATE TABLE IF NOT EXISTS products (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        description TEXT,
        price DECIMAL(10, 2),
        category VARCHAR(50)
    )";
    mysqli_query($conn, $create_products);
    
    # Insert sample data if tables are empty
    $check_users = mysqli_query($conn, "SELECT COUNT(*) as count FROM users");
    $row = mysqli_fetch_assoc($check_users);
    
    if ($row['count'] == 0) {
        # Fixed: Added missing comma after 'jane' user
        mysqli_query($conn, "INSERT INTO users (username, password, email, role) VALUES 
            ('admin', 'admin123', 'admin@example.com', 'admin'),
            ('john', 'password', 'john@example.com', 'user'),
            ('jane', 'password123', 'jane@example.com', 'user'),
            ('mike', 'testpass321', 'mike@example.com', 'user')");
        
        mysqli_query($conn, "INSERT INTO products (name, description, price, category) VALUES 
            ('Laptop', 'High-performance laptop', 999.99, 'Electronics'),
            ('Mouse', 'Wireless mouse', 29.99, 'Electronics'),
            ('Keyboard', 'Mechanical keyboard', 89.99, 'Electronics'),
            ('Monitor', '27-inch 4K monitor', 399.99, 'Electronics'),
            ('Headphones', 'Noise-cancelling headphones', 199.99, 'Electronics')");
    }
}

# Select the database after connection
mysqli_select_db($conn, $db_name);

# Uncomment the line below to run setup on first page load, then comment it back out
# setup_database();
?>
