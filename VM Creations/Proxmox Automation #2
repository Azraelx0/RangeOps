# Deploy-CourseVMs.ps1
param(
    [Parameter(Mandatory=$true)]
    [string]$CourseFile,
    
    [Parameter(Mandatory=$true)]
    [string]$RosterFile
)
# Function to parse YAML file
function Get-YamlContent {
    param([string]$FilePath)
    
    if (-not (Test-Path $FilePath)) {
        throw "File not found: $FilePath"
    }
    
    $content = Get-Content $FilePath -Raw
    return $content
}
# Function to extract course information from YAML
function Get-CourseInfo {
    param([string]$YamlContent)
    
    $courseInfo = @{}
    
    if ($YamlContent -match 'The name of the field i\.e\. "([^"]+)"') {
        $courseInfo.CourseName = $Matches[1]
    }
    
    if ($YamlContent -match '# The ID of the course i\.e\. "([^"]+)"') {
        $courseInfo.CourseID = $Matches[1]
    }
    
    if ($YamlContent -match 'Base_VM_Location:\s*(\S+)') {
        $courseInfo.BaseVMLocation = $Matches[1]
    }
    
    if ($YamlContent -match '# The node that clones will be stored on i\.e\. "([^"]+)"') {
        $courseInfo.CloneVMLocation = $Matches[1]
    }
    
    if ($YamlContent -match '# The first five characters of the VNet ID, should be labeled with the field and a unique VNet id i\.e\. "([^"]+)"') {
        $courseInfo.VNetID = $Matches[1]
    }
    
    $courseInfo.RequiredVMs = @()
    if ($YamlContent -match 'Required_VMs:([\s\S]*?)(?=\n\S|\z)') {
        $vmsSection = $Matches[1]
        $vmMatches = [regex]::Matches($vmsSection, 'VMNAME\d+:[\s\S]*?Base_VM_Name:\s*(\S+)')
        foreach ($match in $vmMatches) {
            $courseInfo.RequiredVMs += $match.Groups[1].Value
        }
    }
    return $courseInfo
}
# Function to read roster file
function Get-RosterUsers {
    param([string]$RosterFile)
    
    if (-not (Test-Path $RosterFile)) {
        throw "Roster file not found: $RosterFile"
    }
    
    $users = Get-Content $RosterFile | Where-Object { $_.Trim() -ne "" }
    return $users
}
# Function to create resource pool for student
function New-StudentPool {
    param(
        [string]$CourseName,
        [string]$StudentName
    )
    
    $poolID = "$CourseName-students-$StudentName-pool"
    
    Write-Host "Creating pool: $poolID"
    
    try {
        pvesh create /pools -poolid $poolID -comment "Pool for $StudentName in $CourseName"
    } catch {
        Write-Host "Pool may already exist: $_"
    }
    
    return $poolID
}
# Function to assign user permissions to pool
function Set-PoolPermissions {
    param(
        [string]$Username,
        [string]$PoolID
    )
    
    Write-Host "Assigning permissions for $Username to pool $PoolID"
    
    try {
        pveum acl modify /pool/$PoolID -users "$Username@cyber.local" -roles PVEVMUser
    } catch {
        Write-Host "Error assigning permissions: $_"
    }
}
# Function to clone VM for student
function Copy-VMForStudent {
    param(
        [string]$TemplateVM,
        [string]$StudentName,
        [string]$PoolID,
        [string]$TargetNode
    )
    
    $newVMName = "$StudentName-$TemplateVM"
    Write-Host "Cloning $TemplateVM to $newVMName"
    try {
        $vmList = pvesh get /cluster/resources --type vm --output-format json | ConvertFrom-Json
        $templateVMID = ($vmList | Where-Object { $_.name -eq $TemplateVM }).vmid
        
        if (-not $templateVMID) {
            Write-Host "Template VM not found: $TemplateVM"
            return
        }
        
        $nextVMID = (pvesh get /cluster/nextid)
        
        pvesh create /nodes/$TargetNode/qemu/$templateVMID/clone -newid $nextVMID -name $newVMName -full 0 -pool $PoolID
        
        Start-Sleep -Seconds 2
        pvesh set /nodes/$TargetNode/qemu/$nextVMID/config -net0 "virtio,bridge=intern-net"
        
        Write-Host "VM cloned successfully (VMID: $nextVMID)"
        
    } catch {
        Write-Host "Error cloning VM: $_"
    }
}
# Main script execution
Write-Host "Loading course configuration..."
$yamlContent = Get-YamlContent -FilePath $CourseFile
$courseInfo = Get-CourseInfo -YamlContent $yamlContent

Write-Host "Course: $($courseInfo.CourseName)"
Write-Host "Required VMs: $($courseInfo.RequiredVMs.Count)"

Write-Host "Loading roster..."
$students = Get-RosterUsers -RosterFile $RosterFile
Write-Host "Students found: $($students.Count)"

Write-Host "Creating student pools..."
$studentPools = @{}

foreach ($student in $students) {
    Write-Host "Processing student: $student"
    
    $poolID = New-StudentPool -CourseName $courseInfo.CourseName -StudentName $student
    $studentPools[$student] = $poolID
    
    Set-PoolPermissions -Username $student -PoolID $poolID
}

Write-Host "Cloning VMs for each student..."

foreach ($student in $students) {
    Write-Host "Deploying VMs for: $student"
    $poolID = $studentPools[$student]
    
    foreach ($vmTemplate in $courseInfo.RequiredVMs) {
        Copy-VMForStudent -TemplateVM $vmTemplate -StudentName $student -PoolID $poolID -TargetNode $courseInfo.CloneVMLocation
    }
}

Write-Host "Deployment complete!"
Write-Host "Course: $($courseInfo.CourseName)"
Write-Host "Students processed: $($students.Count)"
Write-Host "VMs per student: $($courseInfo.RequiredVMs.Count)"
Write-Host "Total VMs created: $($students.Count * $courseInfo.RequiredVMs.Count)"
