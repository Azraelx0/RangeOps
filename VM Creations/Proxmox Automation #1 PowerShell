# Create Linked Clone Proxmox Automation
Install-Module -Name Corsinvest.ProxmoxVE.API
Import-Module Corsinvest.ProxmoxVE.API

$pveServer = "192.168.1.100:8006"
$tokenUser = "Intern-API@pve!InternToken"
$tokenSecret = "20793bd9-6b57-4c6f-8687-90eeb2bec3bf"

# Clone Configuration Variables
$sourceVmid = 1046 # The ID of the template you are cloning from
$targetNode = "nitrogen" # Host to deploy to
$newVmid = 1049 # ID for the new VM
$newName = "mercer-testvm"
$storage = "NFS-PVEVM" # The storage to use for the new VM's delta disk
$pool = "Interns"

# Connect to Proxmox
$client = Connect-PveCluster -HostAndPort $pveServer -ApiToken @{
    user = $tokenUser
    token = $tokenSecret
}

# Create Linked Clone
New-PveNodesQemuClone `
    -PveTicket $client `
    -Node $targetNode `
    -Vmid $sourceVmid `
    -Newid $newVmid `
    -Name $newName `
    -Storage $storage `
    -Pool $pool `
    -Full 0

Write-Host "VM '$newName' has been created as linked clone on target node '$targetNode'"
